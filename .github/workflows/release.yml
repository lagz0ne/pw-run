name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - target: linux-x64
            os: ubuntu-latest
            artifact: bwsr-linux-x64
          - target: linux-arm64
            os: ubuntu-latest
            artifact: bwsr-linux-arm64
          - target: darwin-x64
            os: macos-latest
            artifact: bwsr-darwin-x64
          - target: darwin-arm64
            os: macos-latest
            artifact: bwsr-darwin-arm64
          - target: windows-x64
            os: ubuntu-latest
            artifact: bwsr-windows-x64.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Build binary
        run: |
          bun build --compile --minify src/index.ts \
            --target=bun-${{ matrix.target }} \
            --outfile dist/${{ matrix.artifact }} \
            --external chromium-bidi --external electron

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find dist -type f -exec mv {} release/ \;
          chmod +x release/bwsr-*
          ls -la release/

      - name: Create checksums
        run: |
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
          generate_release_notes: true

  publish-npm:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - run: bun install

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup npm packages
        run: |
          mkdir -p npm-packages

          # Create platform-specific packages
          for platform in linux-x64 linux-arm64 darwin-x64 darwin-arm64; do
            pkg_name="@bwsr/${platform}"
            pkg_dir="npm-packages/${platform}"
            mkdir -p "${pkg_dir}"

            # Find and copy binary
            find artifacts -name "bwsr-${platform}*" -exec cp {} "${pkg_dir}/bwsr" \;
            chmod +x "${pkg_dir}/bwsr"

            # Create package.json
            cat > "${pkg_dir}/package.json" << EOF
          {
            "name": "${pkg_name}",
            "version": "${GITHUB_REF_NAME#v}",
            "os": ["$(echo $platform | cut -d- -f1)"],
            "cpu": ["$(echo $platform | cut -d- -f2)"],
            "bin": {
              "bwsr": "./bwsr"
            }
          }
          EOF
          done

          # Windows package
          pkg_dir="npm-packages/windows-x64"
          mkdir -p "${pkg_dir}"
          find artifacts -name "bwsr-windows-x64*" -exec cp {} "${pkg_dir}/bwsr.exe" \;
          cat > "${pkg_dir}/package.json" << EOF
          {
            "name": "@bwsr/windows-x64",
            "version": "${GITHUB_REF_NAME#v}",
            "os": ["win32"],
            "cpu": ["x64"],
            "bin": {
              "bwsr": "./bwsr.exe"
            }
          }
          EOF

      - name: Create main package
        run: |
          mkdir -p npm-packages/bwsr
          VERSION="${GITHUB_REF_NAME#v}"

          cat > npm-packages/bwsr/package.json << EOF
          {
            "name": "bwsr",
            "version": "${VERSION}",
            "description": "Fast CLI for managing browser daemons via Playwright CDP",
            "bin": {
              "bwsr": "./bin/bwsr.js"
            },
            "optionalDependencies": {
              "@bwsr/linux-x64": "${VERSION}",
              "@bwsr/linux-arm64": "${VERSION}",
              "@bwsr/darwin-x64": "${VERSION}",
              "@bwsr/darwin-arm64": "${VERSION}",
              "@bwsr/windows-x64": "${VERSION}"
            },
            "repository": {
              "type": "git",
              "url": "https://github.com/lagz0ne/pw-run"
            },
            "keywords": ["browser", "playwright", "cdp", "automation", "cli"],
            "license": "MIT"
          }
          EOF

          mkdir -p npm-packages/bwsr/bin
          cat > npm-packages/bwsr/bin/bwsr.js << 'EOF'
          #!/usr/bin/env node
          const { execFileSync } = require("child_process");
          const { join } = require("path");

          const platforms = {
            "darwin-x64": "@bwsr/darwin-x64",
            "darwin-arm64": "@bwsr/darwin-arm64",
            "linux-x64": "@bwsr/linux-x64",
            "linux-arm64": "@bwsr/linux-arm64",
            "win32-x64": "@bwsr/windows-x64",
          };

          const key = `${process.platform}-${process.arch}`;
          const pkg = platforms[key];

          if (!pkg) {
            console.error(`Unsupported platform: ${key}`);
            process.exit(1);
          }

          try {
            const binPath = require.resolve(pkg);
            const bwsr = join(binPath, "..", process.platform === "win32" ? "bwsr.exe" : "bwsr");
            execFileSync(bwsr, process.argv.slice(2), { stdio: "inherit" });
          } catch (e) {
            console.error(`Failed to run bwsr: ${e.message}`);
            process.exit(1);
          }
          EOF

      - name: Publish to npm
        run: |
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc

          # Publish platform packages first
          for dir in npm-packages/linux-* npm-packages/darwin-* npm-packages/windows-*; do
            if [ -d "$dir" ]; then
              echo "Publishing $(basename $dir)..."
              cd "$dir"
              npm publish --access public || true
              cd -
            fi
          done

          # Publish main package
          cd npm-packages/bwsr
          npm publish --access public
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
